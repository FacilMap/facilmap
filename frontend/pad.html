<!DOCTYPE html>
<html ng-controller="PadCtrl">
	<head>
		<meta charset="utf-8">
		<title fp-title="padData.name + ' – FacilPad'">FacilPad</title>
		<script src="js/pad.js"></script>
		<style type="text/css">
			@import "pad.css";
			@import "lib/jquery.ui.spinner-1.10.4.min.css";
		</style>
	</head>
	<body>
		<div ng-hide="loaded" style="position:absolute; top:0; left:0; right:0; bottom:0; padding:10px; background: #fff; z-index:100000; font-size:1.5em; font-weight:bold;">
			Loading...
		</div>
		<div id="map"></div>
		<div id="map-disabled-cover" ng-show="!loaded || error"></div>

		<ul id="toolbox">
			<li ng-repeat="type in types" fp-variable-menu-item><a href="javascript:" ng-click="addObject(type)" ng-hide="readonly">Add {{type.name}}</a></li>
			<li><a href="javascript:">Views</a><ul>
				<li ng-repeat="(id, view) in views" fp-variable-menu-item><a href="javascript:" ng-click="displayView(view)">{{view.name}}</a></li>
				<li><a href="javascript:" ng-click="openDialog('save-view-dialog')" ng-hide="readonly">Save current view</a></li>
				<li><a href="javascript:" ng-click="openDialog('manage-views-dialog')" ng-hide="readonly">Manage views</a></li>
			</ul></li>
			<li><a href="javascript:">Layers</a><ul>
				<li ng-repeat="layer in layers" fp-variable-menu-item>
					<a href="javascript:" ng-click="setLayer(layer)">
						<input type="{{layer.isBaseLayer ? 'radio' : 'checkbox'}}" ng-checked="layer.visibility" />
						{{layer.name}}
					</a>
				</li>
			</ul></li>
			<li><a href="javascript:">Tools</a><ul>
				<!--<li><a href="javascript:" ng-click="openDialog('copy-pad-dialog')" ng-hide="readonly">Copy pad</a></li>-->
				<li><a href="javascript:" ng-click="openDialog('pad-settings-dialog')" ng-hide="readonly">Pad settings</a></li>
				<li><a href="javascript:" ng-click="openDialog('object-types-dialog')" ng-hide="readonly">Object types</a></li>
			</ul></li>
		</ul>

		<div id="messages">
			<p ng-repeat="message in messages" class="{{message.type}}">
				{{message.message}}
				<span ng-repeat="button in message.buttons">&nbsp;<a href="{{button.url || 'javascript:'}}" ng-click="button.click && button.click()">{{button.label}}</a></span>
				<a href="javascript:" class="close-button" ng-click="closeMessage(message)">×</a>
			</p>
		</div>

		<div id="save-view-dialog" title="Save current view" fp-dialog>
			<form>
				<p class="error" ng-hide="!dialogError">{{dialogError}}</p>
				<dl>
					<dt><label for="save-view-name">Name</label></dt>
					<dd><input id="save-view-name" ng-model="saveViewName"></dd>
				</dl>
				<div>
					<button type="submit" ng-click="saveView()">Save</button>
					<button ng-click="saveView(true)">Save and make default view</button>
				</div>
			</form>
		</div>

		<div id="manage-views-dialog" title="Manage views" fp-dialog>
			<p class="error" ng-hide="!dialogError">{{dialogError}}</p>
			<table>
				<tbody>
					<tr ng-class="{selected: view.id == padData.defaultView.id}" ng-repeat="view in views">
						<td><a href="javascript:" ng-click="displayView(view)">{{view.name}}</a></td>
						<td class="button"><button ng-hide="view.id == padData.defaultView.id" ng-click="setDefaultView(view)">Make default</button></td>
						<td class="button"><button ng-click="deleteView(view)">Delete</button></td>
					</tr>
				</tbody>
			</table>
		</div>

		<div id="view-marker-popup" fp-popup="currentMarker.xy">
			<div class="content">
				<h2>{{currentMarker.name}}</h2>
				<p class="pos">Coordinates: {{round(currentMarker.lat, 5)}}, {{round(currentMarker.lon, 5)}}</p>
				<dl>
					<dt ng-repeat-start="field in types[currentMarker.typeId].fields" ng-show="field.type != 'dropdown' || field.options.length > 1">{{field.name}}</dt>
					<dd ng-repeat-end ng-show="field.type != 'dropdown' || field.options.length > 1" fp-type-field-content="field" fp-type-field-model="currentMarker.data[field.name]"></dd>
				</dl>
			</div>
			<div class="buttons">
				<button ng-click="openDialog('edit-marker-dialog')" ng-hide="readonly">Edit</button>
				<button ng-click="moveMarker(currentMarker)" ng-hide="readonly">Move</button>
				<button ng-click="deleteMarker(currentMarker)" ng-hide="readonly">Remove</button>
			</div>
			<a href="javascript:" ng-click="currentMarker=null" class="close-button">×</a>
		</div>

		<div id="view-line-popup" fp-popup="currentLine.clickXy">
			<div class="content">
				<h2>{{currentLine.name}}</h2>
				<p class="distance">Distance: {{round(currentLine.distance, 2)}} km <span ng-show="currentLine.time != null">({{formatTime(currentLine.time)}} h{{routingMode(currentLine.mode)}})</span></p>
				<dl>
					<dt ng-repeat-start="field in types[currentLine.typeId].fields" ng-show="field.type != 'dropdown' || field.options.length > 1">{{field.name}}</dt>
					<dd ng-repeat-end ng-show="field.type != 'dropdown' || field.options.length > 1" fp-type-field-content="field" fp-type-field-model="currentLine.data[field.name]"></dd>
				</dl>
			</div>
			<div class="buttons">
				<button ng-click="openDialog('edit-line-dialog')" ng-hide="readonly">Edit</button>
				<button ng-click="moveLine(currentLine)" ng-hide="readonly">Move</button>
				<button ng-click="deleteLine(currentLine)" ng-hide="readonly">Remove</button>
			</div>
			<a href="javascript:" ng-click="currentLine=null" class="close-button">×</a>
		</div>

		<div id="edit-marker-dialog" title="Edit marker" fp-dialog fp-preserve="markers[currentMarker.id]">
			<form>
				<p class="error" ng-show="dialogError">{{dialogError}}</p>
				<dl>
					<dt><label for="edit-marker-name">Name</label></dt>
					<dd><input id="edit-marker-name" ng-model="currentMarker.name" /></dd>

					<dt><label for="edit-marker-colour">Colour</label></dt>
					<dd><input id="edit-marker-colour" ng-model="currentMarker.colour" fp-colour-picker></dd>

					<dt ng-repeat-start="field in types[currentMarker.typeId].fields" ng-show="field.type != 'dropdown' || field.options.length > 1"><label for="marker-{{$index}}-input">{{field.name}}</label></dt>
					<dd ng-repeat-end ng-show="field.type != 'dropdown' || field.options.length > 1" fp-type-field="field" fp-type-field-model="currentMarker.data[field.name]" fp-type-field-id="marker-{{$index}}-input"></dd>
				</dl>
				<div>
					<button ng-click="saveMarker(currentMarker)">Save</button>
				</div>
			</form>
		</div>

		<div id="edit-line-dialog" title="Edit line" fp-dialog fp-preserve="lines[currentLine.id]">
			<form>
				<p class="error" ng-show="dialogError">{{dialogError}}</p>
				<dl>
					<dt><label for="edit-line-name">Name</label></dt>
					<dd><input id="edit-line-name" ng-model="currentLine.name" /></dd>

					<dt><label for="edit-line-mode">Routing mode</label></dt>
					<dd><select id="edit-line-mode" ng-model="currentLine.mode">
						<option value="">None</option>
						<option value="fastest">Car (fastest)</option>
						<option value="shortest">Car (shortest)</option>
						<option value="bicycle">Bicycle</option>
						<option value="pedestrian">Pedestrian</option>
					</select></dd>

					<dt><label for="edit-line-colour">Colour</label></dt>
					<dd><input id="edit-line-colour" ng-model="currentLine.colour" fp-colour-picker></dd>

					<dt><label for="edit-line-width">Width</label></dt>
					<dd><input id="edit-line-width" ng-model="currentLine.width" fp-spinner /></dd>

					<dt ng-repeat-start="field in types[currentLine.typeId].fields" ng-show="field.type != 'dropdown' || field.options.length > 1"><label for="line-{{$index}}-input">{{field.name}}</label></dt>
					<dd ng-repeat-end ng-show="field.type != 'dropdown' || field.options.length > 1" fp-type-field="field" fp-type-field-model="currentLine.data[field.name]" fp-type-field-id="line-{{$index}}-input"></dd>
				</dl>
				<div>
					<button ng-click="saveLine(currentLine)">Save</button>
				</div>
			</form>
		</div>

		<div id="pad-settings-dialog" title="Pad settings" fp-dialog fp-preserve="padData">
			<form>
				<p class="error" ng-show="dialogError">{{dialogError}}</p>
				<dl>
					<dt>Link</dt>
					<dd>{{urlPrefix}}{{padId}}</dd>

					<dt>Read-only link</dt>
					<dd>{{urlPrefix}}{{padData.id}}</dd>

					<dt><label for="pad-name-input">Pad name</label></dt>
					<dd><input id="pad-name-input" ng-model="padData.name" /></dd>
				</dl>
				<div>
					<button ng-click="savePadData()">Save</button>
				</div>
			</form>
		</div>

		<div id="object-types-dialog" title="Object types" fp-dialog>
			<form>
				<p class="error" ng-show="dialogError">{{dialogError}}</p>
				<table class="border">
					<thead>
						<tr>
							<th>Name</th>
							<th>Type</th>
							<th colspan="3">Edit</th>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="type in types">
							<td>{{type.name}}</td>
							<td>{{type.type}}</td>
							<td class="button"><button ng-click="editType(type)">Edit</button><button ng-click="deleteType(type)">Delete</button></td>
						</tr>
					</tbody>
					<tfoot>
						<tr>
							<td colspan="4"><button ng-click="createType()">Create</button></td>
						</tr>
					</tfoot>
				</table>
			</form>
		</div>

		<div id="edit-type-dialog" title="Edit object type" fp-dialog fp-preserve="currentType">
			<form>
				<p class="error" ng-show="dialogError">{{dialogError}}</p>
				<dl>
					<dt><label for="type-name-input">Name</label></dt>
					<dd><input id="type-name-input" type="text" ng-model="currentType.name" /></dd>

					<dt><label for="type-type-input">Type</label></dt>
					<dd><select id="type-type-input" ng-model="currentType.type" ng-disabled="currentType.id != null">
						<option value="marker">Marker</option>
						<option value="line">Line</option>
					</select></dd>
				</dl>
				<h2>Fields</h2>
				<table class="border">
					<thead>
						<tr>
							<th>Name</th>
							<th>Type</th>
							<th>Default value</th>
							<th>Delete</th>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="field in currentType.fields">
							<td><input type="text" ng-model="field.name"/></td>
							<td><select ng-model="field.type">
								<option value="input">Text field</option>
								<option value="textarea">Text area</option>
								<option value="dropdown">Dropdown</option>
								<option value="checkbox">Checkbox</option>
							</select> <button ng-show="field.type == 'dropdown'" ng-click="editTypeDropdown(currentType, field)">Edit</button></td>
							<td fp-type-field="field" fp-type-field-model="field.default" fp-type-field-ignore-default></td>
							<td><button ng-click="deleteTypeField(currentType, field)">Delete</button></td>
						</tr>
					</tbody>
					<tfoot>
						<tr>
							<td colspan="4"><button ng-click="createTypeField(currentType)">+</button></td>
						</tr>
					</tfoot>
				</table>
				<div>
					<button ng-click="saveType(currentType)">Save</button>
				</div>
			</form>
		</div>

		<div id="edit-type-dropdown-dialog" title="Edit dropdown" fp-dialog fp-preserve="currentField">
			<form>
				<div><input type="checkbox" id="control-colour-input" ng-model="currentField.controlColour" ng-disabled="!fieldCanControl(currentType, currentField, 'colour')"><label for="control-colour-input" ng-class="{disabled: !fieldCanControl(currentType, currentField, 'colour')}"> Control {{currentType.type}} colour</label></div>
				<div ng-show="currentType.type == 'line'"><input type="checkbox" id="control-width-input" ng-model="currentField.controlWidth" ng-disabled="!fieldCanControl(currentType, currentField, 'width')"><label for="control-width-input" ng-class="{disabled: !fieldCanControl(currentType, currentField, 'width')}"> Control {{currentType.type}} width</label></div>
				<table class="border">
					<thead>
						<tr>
							<th>Option</th>
							<th ng-show="currentField.controlColour">Colour</th>
							<th ng-show="currentField.controlWidth">Width</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="option in currentField.options">
							<td><input type="text" ng-model="option.value"></td>
							<td ng-show="currentField.controlColour"><input type="text" ng-model="option.colour" fp-colour-picker></td>
							<td ng-show="currentField.controlWidth"><input type="text" ng-model="option.width" fp-spinner></td>
							<td><button ng-click="deleteTypeDropdownOption(currentField, option)">−</button></td>
						</tr>
					</tbody>
					<tfoot>
						<tr>
							<td colspan="4"><button ng-click="addTypeDropdownOption(currentField)">+</button></td>
						</tr>
					</tfoot>
				</table>
				<div><button ng-click="saveTypeFieldDropdown(currentField)">OK</button></div>
			</form>
		</div>

		<div id="copy-pad-dialog" title="Copy pad" fp-dialog>
			<form>
				<p class="error" ng-show="dialogError">{{dialogError}}</p>
				<dl>
					<dt>Copy to</dt>
					<dd>{{urlPrefix}}<input ng-model="copyPadId" class="inline" /></dd>
				</dl>
				<div>
					<button ng-click="copyPad()">Copy</button>
				</div>
			</form>
		</div>

		<ul id="colour-picker">
			<li ng-repeat="colour in colours" ng-style="{ 'background-color': '#'+colour }" data-colour="{{colour}}"></li>
		</ul>
	</body>
</html>